<template id="user-account">
	<style>
		@import "/modules/wwi/component/design/host.css";
		:host{
			position: relative;
			display:block;
			background-color: var(--cream-light);
			height:auto;
			width:400px;
			border-radius: 10px;
			filter:drop-shadow(0 2px 15px rgba(0,0,0,0.3));
		}

		select-menu{
			--option-background:rgba(255,255,255,0.9);
			--background:rgba(255,255,255,0.72);
			--color:var(--chocolate);
			width: calc(100% - 20px);
			height: calc(100% - 20px);
			padding:5px;
			margin:10px;
		}

		content-action,content-action-check{
			-webkit-backface-visibility: hidden;
			backface-visibility: hidden;
		}

		content-action{
			display: inline-block;
			position:relative;
			border-radius: 100px;
			font-weight: 900;
			font-size:20px;
			padding:5px 38px;
			color:var(--teal-bright);
			background-color: var(--chocolate);
		}
		content-action-check{
			--padding:2px 5px 0px 5px;
			margin:5px;
			color:var(--chocolate);
		}

		[view]{

			max-height: calc(100vh - 40px);
			overflow-y: auto;
		}

	</style>

	<div view>

		<user-contact></user-contact>

		<select-menu toggles providers>
			<!--<select-option name="Google" wwi icon="provider/google.png"></select-option>-->
			<!--<select-option name="Facebook" wwi icon="provider/facebook.png"></select-option>-->
			<!--<select-option name="Twitter" wwi icon="provider/twitter.png"></select-option>-->
			<!--<select-option name="Email" wwi icon="provider/email.png"></select-option>-->
			<!--<select-option name="Create" wwi icon="provider/sunny.svg"></select-option>-->
		</select-menu>

		<div style="margin-top:10px;" gui vertical center-center>
			<content-action sign-in-button>Sign In</content-action>
			<content-action-check use-popup checked icons="star,star_border">Use Pop-up:</content-action-check>
		</div>

	</div>
</template>
<script>
	(function(doc){
		const UserAccount = wwi.element(doc).extension(
			{module:'axy',name:'UserMix'},
			{module:'axy',name:'Providers'})

		UserAccount(class extends UserAccount.Element{


			changed(name,old,value){
				console.log(name)
			}
			connected(){
				this.define({available_providers:true})

				let api = this.api
				let available_providers = this.available_providers
				if(available_providers){
					let set_providers = fxy.require('axy/set_providers')
					set_providers(this,available_providers)
				}

				this.sign_in_button.on.click = e=>{
					if(this.signed_in) this.api.sign_out()
					else this.sign_in()
				}

				api.account.changed(e=>{
					this.user = e
					this.contact.data = this.user.data
					if(this.user.signed_in) this.sign_in_button.innerHTML = 'Sign Out'
					else this.sign_in_button.innerHTML = 'Sign In'
					console.group('Changed User:')
					console.log(e)
					console.groupEnd()
				})

				this.providers.on('change',e=>this.sign_in())
			}
			get sign_in_button(){ return this.query('[sign-in-button]')}
			sign_in(){
				let item = this.providers.selected
				if(!item) return this.providers.open()
				let api = this.api
				let providers = api.providers
				let sign_in = api.sign_in
				if(item.hasAttribute('action')){
					let action_name = item.getAttribute('action')
					let action = sign_in[action_name]
					if(action) {
						return action().then(result=>sign_in_success(this,result))
						               .catch(error=>sign_in_error(this,error))
					}
				}
				let provider = item.name in providers ? providers[item.name]:null
				if(!provider) return console.error(`Provider ${item.name} does not exist.`)
				if(this.use_popup){
					sign_in.with_popup(provider)
					       .then(result=>sign_in_success(this,result))
					       .catch(error=>sign_in_error(this,error))
				}
				else{
					sign_in.with_redirect(provider)
					sign_in.redirect_result()
					       .then(result=>sign_in_success(this,result))
					       .catch(error=>sign_in_error(this,error))
				}
			}
			get signed_in(){ return this.user && this.user.signed_in }
			get contact(){ return this.query('user-contact') }
			get use_popup(){ return this.query('[use-popup]').checked !== null }
		})

		function sign_in_success(account,result){

		}
		function sign_in_error(account,error){

		}
	})(document)
</script>

